pkgs <- c("tidyverse",
"lubridate",
"haven",
"readxl",
"stats",
"splines",
"MASS",
"gnm",
'doParallel',
'foreach')
# install.packages("doParallel")
lapply(pkgs, require, character.only = T)
select <- dplyr::select
registerDoParallel(cores = 4)
source("Code/00_functions.R")
# reading mortality and population data from StatCan files
db <- read_rds("Output/weekly_canada.rds")
# database for baseline estimation
db2 <- db %>%
mutate(Deaths = Deaths + 1) %>%
group_by(Year, Region, Age, Sex) %>%
mutate(Week = 1:n()) %>%
ungroup() %>%
arrange(Region, Age, Sex, Year) %>%
group_by(Region, Age, Sex) %>%
mutate(t = 1:n()) %>%
ungroup() %>%
mutate(sn52 = sin((2*pi*t)/(52)),
cs52 = cos((2*pi*t)/(52)),
# excluding winter (wks 46-14), summer (wks 27-35), 2009 and COVID-19 pandemics
include = ifelse(((Week >= 15 & Week <= 26) |
(Week >= 36 & Week <= 45)) &
(Year != 2020 & Year != 2009),
1, 0))
skip_to_next <- F
# c <- "Canada"
# s <- "b"
# a <- "All"
ym <- 2010
cts <- unique(db2$Region)
cts <- c("Canada", "Ontario", "Quebec")
cts <- c("British Columbia", "Alberta", "Canada", "Ontario", "Quebec")
sxs <- unique(db2$Sex)
ags <- unique(db2$Age)
db_all_blns <- NULL
for (c in cts) {
for (s in sxs) {
for (a in ags) {
temp <- db2 %>%
filter(Region == c,
Sex == s,
Age == a,
Year >= ym)
cat(paste(c, s, a, "\n", sep = "_"))
temp2 <- fit_baseline(temp)
db_all_blns <- db_all_blns %>%
bind_rows(temp2)
}
}
}
for (i in pkgs){
if (!(i %in% rownames(installed.packages()))){
install.packages(i)
}
}
lapply(pkgs, require, character.only = T)
select <- dplyr::select
registerDoParallel(cores = 4)
source("Code/00_functions.R")
# reading mortality and population data from StatCan files
db <- read_rds("Output/weekly_canada.rds")
# database for baseline estimation
db2 <- db %>%
mutate(Deaths = Deaths + 1) %>%
group_by(Year, Region, Age, Sex) %>%
mutate(Week = 1:n()) %>%
ungroup() %>%
arrange(Region, Age, Sex, Year) %>%
group_by(Region, Age, Sex) %>%
mutate(t = 1:n()) %>%
ungroup() %>%
mutate(sn52 = sin((2*pi*t)/(52)),
cs52 = cos((2*pi*t)/(52)),
# excluding winter (wks 46-14), summer (wks 27-35), 2009 and COVID-19 pandemics
include = ifelse(((Week >= 15 & Week <= 26) |
(Week >= 36 & Week <= 45)) &
(Year != 2020 & Year != 2009),
1, 0))
skip_to_next <- F
# c <- "Canada"
# s <- "b"
# a <- "All"
ym <- 2010
cts <- unique(db2$Region)
cts <- c("Canada", "Ontario", "Quebec")
cts <- c("British Columbia", "Alberta", "Canada", "Ontario", "Quebec")
sxs <- unique(db2$Sex)
ags <- unique(db2$Age)
db_all_blns <- NULL
for (c in cts) {
for (s in sxs) {
for (a in ags) {
temp <- db2 %>%
filter(Region == c,
Sex == s,
Age == a,
Year >= ym)
cat(paste(c, s, a, "\n", sep = "_"))
temp2 <- fit_baseline(temp)
db_all_blns <- db_all_blns %>%
bind_rows(temp2)
}
}
}
#########################
# appending all estimates
#########################
# db_all <- NULL
# getwd()
#
# temp = list.files("Data_output/single_ests/", pattern="*.csv")
#
# length(temp)
# # i <- 1
# for (i in 1:length(temp)) {
#   db_temp <- read_csv(paste0("Data_output/single_ests/", temp[i])) %>%
#     as_tibble() %>%
#     mutate(Sex = as.character(Sex),
#            Sex = ifelse(Sex == "FALSE", "f", Sex))
#   db_all <- bind_rows(db_all, db_temp)
# }
#
# detach(package:MASS)
#
write_csv(db_all_blns, path = paste0("Output/baseline_mortality_", ym, ".csv"))
rm(list=ls())
Sys.setenv(LANG = "en")
Sys.setlocale("LC_ALL","English")
pkgs <- c("tidyverse",
"lubridate",
"haven",
"readxl",
"stats",
"splines",
"MASS",
"gnm",
'doParallel',
'foreach')
# for (i in pkgs){
#   if (!(i %in% rownames(installed.packages()))){
#     install.packages(i)
#   }
# }
lapply(pkgs, require, character.only = T)
select <- dplyr::select
registerDoParallel(cores = 4)
source("Code/00_functions.R")
# reading mortality and population data from StatCan files
db <- read_rds("Output/weekly_canada.rds")
# database for baseline estimation
db2 <- db %>%
mutate(Deaths = Deaths + 1) %>%
group_by(Year, Region, Age, Sex) %>%
mutate(Week = 1:n()) %>%
ungroup() %>%
arrange(Region, Age, Sex, Year) %>%
group_by(Region, Age, Sex) %>%
mutate(t = 1:n()) %>%
ungroup() %>%
mutate(sn52 = sin((2*pi*t)/(52)),
cs52 = cos((2*pi*t)/(52)),
# excluding winter (wks 46-14), summer (wks 27-35), 2009 and COVID-19 pandemics
include = ifelse(((Week >= 15 & Week <= 26) |
(Week >= 36 & Week <= 45)) &
(Year != 2020 & Year != 2009),
1, 0))
skip_to_next <- F
# c <- "Canada"
# s <- "b"
# a <- "All"
ym <- 2014
# temp <- db2 %>%
#   filter(Region == c,
#          Sex == s,
#          Age == a,
#          Year >= ym)
#
# test <- fit_baseline(temp)
# db2 <- temp
cts <- unique(db2$Region)
cts <- c("Canada", "Ontario", "Quebec")
cts <- c("British Columbia", "Alberta", "Canada", "Ontario", "Quebec")
sxs <- unique(db2$Sex)
ags <- unique(db2$Age)
db_all_blns <- NULL
for (c in cts) {
for (s in sxs) {
for (a in ags) {
temp <- db2 %>%
filter(Region == c,
Sex == s,
Age == a,
Year >= ym)
cat(paste(c, s, a, "\n", sep = "_"))
temp2 <- fit_baseline(temp)
db_all_blns <- db_all_blns %>%
bind_rows(temp2)
}
}
}
#########################
# appending all estimates
#########################
# db_all <- NULL
# getwd()
#
# temp = list.files("Data_output/single_ests/", pattern="*.csv")
#
# length(temp)
# # i <- 1
# for (i in 1:length(temp)) {
#   db_temp <- read_csv(paste0("Data_output/single_ests/", temp[i])) %>%
#     as_tibble() %>%
#     mutate(Sex = as.character(Sex),
#            Sex = ifelse(Sex == "FALSE", "f", Sex))
#   db_all <- bind_rows(db_all, db_temp)
# }
#
# detach(package:MASS)
#
write_csv(db_all_blns, path = paste0("Output/baseline_mortality_", ym, ".csv"))
rm(list=ls())
Sys.setenv(LANG = "en")
Sys.setlocale("LC_ALL","English")
pkgs <- c("tidyverse",
"lubridate",
"haven",
"readxl",
"stats",
"splines",
"MASS",
"gnm",
'doParallel',
'foreach')
lapply(pkgs, require, character.only = T)
select <- dplyr::select
registerDoParallel(cores = 4)
source("Code/00_functions.R")
# reading mortality and population data from StatCan files
db <- read_rds("Output/weekly_canada.rds")
# definition of flu seasons and heat waves in Canada
####################################################
# Euromomo definition
exc_type <- "emomo"
flu_season <- c(seq(46, 54, 1), seq(1, 14, 1))
heat_waves <- seq(27, 35, 1)
# option 2 definition
exc_type <- "long_flu"
flu_season <- c(seq(1, 20, 1), seq(40, 54, 1))
heat_waves <- 0
# Initial year for baseline estimation
######################################
ym <- 2010
# database for baseline estimation
##################################
db2 <- db %>%
mutate(Deaths = Deaths + 1) %>%
group_by(Year, Region, Age, Sex) %>%
mutate(Week = 1:n()) %>%
ungroup() %>%
arrange(Region, Age, Sex, Year) %>%
group_by(Region, Age, Sex) %>%
mutate(t = 1:n()) %>%
ungroup() %>%
mutate(sn52 = sin((2*pi*t)/(52)),
cs52 = cos((2*pi*t)/(52)),
# excluding winter (wks 46-14), summer (wks 27-35), 2009 and COVID-19 pandemics
include = ifelse(!(Week %in% heat_waves | Week %in% flu_season) &
(Year != 2020 & Year != 2009),
1, 0))
# skip_to_next <- F
# Testing single populations
############################
# c <- "Quebec"
# s <- "m"
# a <- "All"
#
# temp <- db2 %>%
#   filter(Region == c,
#          Sex == s,
#          Age == a,
#          Year >= ym)
#
# fit_baseline(temp)
# Fitting all regions, sexes, and ages in Canada
################################################
cts <- unique(db2$Region)
cts <- c("Canada", "Ontario", "Quebec")
cts <- c("British Columbia", "Alberta", "Canada", "Ontario", "Quebec")
sxs <- unique(db2$Sex)
ags <- unique(db2$Age)
db_all_blns <- NULL
for (c in cts) {
for (s in sxs) {
for (a in ags) {
temp <- db2 %>%
filter(Region == c,
Sex == s,
Age == a,
Year >= ym)
cat(paste(c, s, a, "\n", sep = "_"))
temp2 <- fit_baseline(temp, exc_type)
db_all_blns <- db_all_blns %>%
bind_rows(temp2)
}
}
}
write_csv(db_all_blns, path = paste0("Output/baseline_mortality_", ym, "_", exc_type, ".csv"))
detach(package:MASS)
rm(list=ls())
Sys.setenv(LANG = "en")
Sys.setlocale("LC_ALL","English")
pkgs <- c("tidyverse",
"lubridate",
"haven",
"readxl",
"stats",
"splines",
"MASS",
"gnm",
'doParallel',
'foreach')
lapply(pkgs, require, character.only = T)
select <- dplyr::select
registerDoParallel(cores = 4)
source("Code/00_functions.R")
# reading mortality and population data from StatCan files
db <- read_rds("Output/weekly_canada.rds")
# definition of flu seasons and heat waves in Canada
####################################################
# Euromomo definition
exc_type <- "emomo"
flu_season <- c(seq(1, 14, 1), seq(46, 54, 1))
heat_waves <- seq(27, 35, 1)
# option 2 definition
exc_type <- "long_flu"
flu_season <- c(seq(1, 18, 1), seq(42, 54, 1))
heat_waves <- 0
# Initial year for baseline estimation
######################################
ym <- 2010
# database for baseline estimation
##################################
db2 <- db %>%
mutate(Deaths = Deaths + 1) %>%
group_by(Year, Region, Age, Sex) %>%
mutate(Week = 1:n()) %>%
ungroup() %>%
arrange(Region, Age, Sex, Year) %>%
group_by(Region, Age, Sex) %>%
mutate(t = 1:n()) %>%
ungroup() %>%
mutate(sn52 = sin((2*pi*t)/(52)),
cs52 = cos((2*pi*t)/(52)),
# excluding winter (wks 46-14), summer (wks 27-35), 2009 and COVID-19 pandemics
include = ifelse(!(Week %in% heat_waves | Week %in% flu_season) &
(Year != 2020 & Year != 2009),
1, 0))
# skip_to_next <- F
# Testing single populations
############################
# c <- "Quebec"
# s <- "m"
# a <- "All"
#
# temp <- db2 %>%
#   filter(Region == c,
#          Sex == s,
#          Age == a,
#          Year >= ym)
#
# fit_baseline(temp)
# Fitting all regions, sexes, and ages in Canada
################################################
cts <- unique(db2$Region)
cts <- c("Canada", "Ontario", "Quebec")
cts <- c("British Columbia", "Alberta", "Canada", "Ontario", "Quebec")
sxs <- unique(db2$Sex)
ags <- unique(db2$Age)
db_all_blns <- NULL
for (c in cts) {
for (s in sxs) {
for (a in ags) {
temp <- db2 %>%
filter(Region == c,
Sex == s,
Age == a,
Year >= ym)
cat(paste(c, s, a, "\n", sep = "_"))
temp2 <- fit_baseline(temp, exc_type)
db_all_blns <- db_all_blns %>%
bind_rows(temp2)
}
}
}
write_csv(db_all_blns, path = paste0("Output/baseline_mortality_", ym, "_", exc_type, ".csv"))
detach(package:MASS)
db_cov <-  read_csv("https://osf.io/7tnfh/download",
skip = 3,
col_types = "ccccciiddd")
rm(list=ls())
Sys.setenv(LANG = "en")
Sys.setlocale("LC_ALL","English")
library(tidyverse)
library(readr)
library(lubridate)
library(ggplot2)
library(osfr)
db_cov <-  read_csv("https://osf.io/7tnfh/download",
skip = 3,
col_types = "ccccciiddd")
View(db_cov)
# OSF Data - Output_10
osf_retrieve_file("43ucn") %>%
osf_download(path = "Data/", conflicts = "overwrite")
db_cov <-  read_csv("Data/Output_10.zip",
skip = 3,
col_types = "ccccciiddd")
# looking for regions included in COVerAGE-DB
db_cov %>%
filter(Country == "Canada") %>%
mutate(Code = str_replace(Code, Date, ""),
Date = dmy(Date)) %>%
pull(Code) %>%
unique()
unique(db_cov$Region)
# looking for regions included in COVerAGE-DB
can <- db_cov %>%
filter(Country == "Canada") %>%
mutate(Code = str_replace(Code, Date, ""),
Date = dmy(Date)) %>%
pull(Code) %>%
unique()
unique(can$Region)
can
# looking for regions included in COVerAGE-DB
db_cov %>%
filter(Country == "Canada") %>%
mutate(Code = str_replace(Code, Date, ""),
Date = dmy(Date)) %>%
pull(Code) %>%
unique()
# only keeping regions from regional sources
db_prv <- db_cov %>%
filter(Country == "Canada") %>%
mutate(Code = str_replace(Code, Date, ""),
Date = dmy(Date)) %>%
select(-Tests)
unique(db_prv$Region)
unique(db_prv$Code)
unique(db_prv$Sex)
View(db_prv)
db2 <- db_prv %>%
drop_na()
View(db_prv)
View(db2)
db2 <- db_prv %>%
drop_na() %>%
select(Region, Date)
db2 <- db_prv %>%
drop_na() %>%
select(Region, Date) %>%
unique()
db2
db2 <- db_prv %>%
drop_na() %>%
select(Region, Date) %>%
unique() %>%
spread(Region)
db2 <- db_prv %>%
drop_na() %>%
select(Region, Date) %>%
unique() %>%
spread("Region")
db2 <- db_prv %>%
drop_na() %>%
select(Region, Date) %>%
unique() %>%
spread(Region, Date)
View(db2)
db2 <- db_prv %>%
drop_na() %>%
select(Region, Date) %>%
unique() %>%
spread(Date, Region)
db2 <- db_prv %>%
drop_na() %>%
select(Region, Date) %>%
unique()
View(db2)
db2 <- db_prv %>%
drop_na() %>%
select(Region, Date) %>%
unique() %>%
mutate(id = 1) %>%
spread(id, Region)
db2 <- db_prv %>%
drop_na() %>%
select(Region, Date) %>%
unique() %>%
mutate(id = 1) %>%
spread(Region, id)
